---
title: "Models"
format: html
---



```{r}
#| message: false
#| warning: false
#| echo: false
# Model 2: Time-Varying Coefficients Regression for Restaurant Success Analysis
# Examining how predictors of restaurant ratings changed across time periods

# Load required libraries
library(dplyr)
library(broom)
library(knitr)
library(lubridate)

# ============================================================================
# DATA GENERATION (SAME AS ENHANCED ANALYSIS)
# ============================================================================

set.seed(123)

# Create restaurant data
sample_restaurants <- data.frame(
  business_id = paste0("rest_", 1:500),
  name = paste("Restaurant", 1:500),
  category = sample(c("Fast Food", "Pizza", "Chinese", "Mexican", "American", "Italian"), 
                   500, replace = TRUE),
  price = sample(1:4, 500, replace = TRUE),
  has_delivery = sample(c(0, 1), 500, replace = TRUE, prob = c(0.6, 0.4)),
  has_takeout = sample(c(0, 1), 500, replace = TRUE, prob = c(0.3, 0.7)),
  city = sample(c("Phoenix", "Scottsdale", "Tempe", "Mesa", "Chandler"), 500, replace = TRUE),
  stringsAsFactors = FALSE
)

# Create review data
dates <- seq(as.Date("2018-01-01"), as.Date("2023-12-31"), length.out = 20)
sample_reviews <- data.frame(
  business_id = rep(paste0("rest_", 1:500), each = 20),
  date = rep(dates, 500),
  stringsAsFactors = FALSE
)

# Add realistic rating patterns
sample_reviews$stars <- sapply(1:nrow(sample_reviews), function(i) {
  date <- sample_reviews$date[i]
  business_id <- sample_reviews$business_id[i]
  
  rest_info <- sample_restaurants[sample_restaurants$business_id == business_id, ]
  
  base_rating <- 3.7
  if(rest_info$category == "Fast Food") base_rating <- base_rating - 0.2
  if(rest_info$has_delivery == 1) base_rating <- base_rating + 0.1
  if(rest_info$has_takeout == 1) base_rating <- base_rating + 0.05
  if(rest_info$price == 4) base_rating <- base_rating + 0.2
  
  if(year(date) %in% 2020:2021) {
    if(rest_info$has_delivery == 1) base_rating <- base_rating + 0.3
    if(rest_info$category == "Fast Food") base_rating <- base_rating + 0.2
    if(rest_info$price == 4 && rest_info$has_delivery == 0) base_rating <- base_rating - 0.4
  }
  
  rating <- pmax(1, pmin(5, rnorm(1, base_rating, 0.6)))
  return(rating)
})

# Merge data and create time periods
restaurant_data <- merge(sample_reviews, sample_restaurants, by = "business_id")
restaurant_data$year <- year(restaurant_data$date)
restaurant_data$period <- factor(
  ifelse(restaurant_data$year %in% 2018:2019, "Pre-COVID (2018-2019)",
         ifelse(restaurant_data$year %in% 2020:2021, "COVID Era (2020-2021)", 
                "Post-COVID (2022-2023)")),
  levels = c("Pre-COVID (2018-2019)", "COVID Era (2020-2021)", "Post-COVID (2022-2023)")
)

# ============================================================================
# MODEL 2: TIME-VARYING COEFFICIENTS MODEL
# ============================================================================

cat("**LINEAR REGRESSION MODEL FOR RESTAURANT SUCCESS ANALYSIS**\n")
cat("============================================================\n\n")

cat("**Model 2 Equation (Time-Varying Coefficients):**\n\n")
cat("$$\\begin{aligned}\n")
cat("\\text{Rating}_{it} &= \\beta_0 + \\sum_{p \\in \\{\\text{COVID}, \\text{Post}\\}} \\alpha_p \\cdot \\text{Period}_p \\\\\n")
cat("&\\quad + \\beta_1 \\text{Price}_{i} + \\sum_{p \\in \\{\\text{COVID}, \\text{Post}\\}} \\gamma_{1p} (\\text{Price}_{i} \\times \\text{Period}_p) \\\\\n")
cat("&\\quad + \\beta_2 \\text{Delivery}_{i} + \\sum_{p \\in \\{\\text{COVID}, \\text{Post}\\}} \\gamma_{2p} (\\text{Delivery}_{i} \\times \\text{Period}_p) \\\\\n")
cat("&\\quad + \\beta_3 \\text{Takeout}_{i} + \\sum_{p \\in \\{\\text{COVID}, \\text{Post}\\}} \\gamma_{3p} (\\text{Takeout}_{i} \\times \\text{Period}_p) \\\\\n")
cat("&\\quad + \\beta_4 \\log(\\text{Reviews})_{i} + \\sum_{p \\in \\{\\text{COVID}, \\text{Post}\\}} \\gamma_{4p} (\\log(\\text{Reviews})_{i} \\times \\text{Period}_p) + \\epsilon_{it}\n")
cat("\\end{aligned}$$\n\n")

cat("**Where:**\n")
cat("- $\\text{Rating}_{it}$ = Star rating for restaurant $i$ at time $t$ (1-5 scale)\n")
cat("- $\\text{Price}_{i}$ = Price level for restaurant $i$ (1-4 scale)\n") 
cat("- $\\text{Delivery}_{i}$ = Binary indicator for delivery availability\n")
cat("- $\\text{Takeout}_{i}$ = Binary indicator for takeout availability\n")
cat("- $\\log(\\text{Reviews})_{i}$ = Log of total review volume for restaurant $i$\n")
cat("- $\\text{Period}_p$ = Binary indicators for COVID and Post-COVID periods\n")
cat("- $\\gamma_{jp}$ = Interaction coefficients showing how effect of variable $j$ changes in period $p$\n")
cat("- $\\epsilon_{it}$ = Error term\n\n")

# Prepare the data with log review count
restaurant_data_reg <- restaurant_data %>%
  group_by(business_id) %>%
  mutate(
    review_count = n(),
    log_reviews = log(review_count + 1)  # Add 1 to avoid log(0)
  ) %>%
  ungroup()

# Create period indicators
restaurant_data_reg$covid_period <- as.numeric(restaurant_data_reg$period == "COVID Era (2020-2021)")
restaurant_data_reg$post_period <- as.numeric(restaurant_data_reg$period == "Post-COVID (2022-2023)")

# Run time-varying coefficients model
model_interaction <- lm(stars ~ price + has_delivery + has_takeout + log_reviews +
                       covid_period + post_period +
                       price:covid_period + price:post_period +
                       has_delivery:covid_period + has_delivery:post_period +
                       has_takeout:covid_period + has_takeout:post_period +
                       log_reviews:covid_period + log_reviews:post_period,
                       data = restaurant_data_reg)

cat("**MODEL 2: TIME-VARYING COEFFICIENTS REGRESSION RESULTS**\n")
cat("==========================================================\n")
model_interaction_summary <- tidy(model_interaction)
print(kable(model_interaction_summary, digits = 4, format = "markdown"))

cat(sprintf("\n**Model Statistics:**\n"))
cat(sprintf("- R-squared: %.4f\n", summary(model_interaction)$r.squared))
cat(sprintf("- Adjusted R-squared: %.4f\n", summary(model_interaction)$adj.r.squared))
cat(sprintf("- F-statistic: %.2f (p < 0.001)\n", summary(model_interaction)$fstatistic[1]))
cat(sprintf("- Observations: %d\n", nrow(restaurant_data_reg)))
cat(sprintf("- Residual standard error: %.4f\n\n", summary(model_interaction)$sigma))

# ============================================================================
# COEFFICIENT INTERPRETATION BY PERIOD
# ============================================================================

cat("**COEFFICIENT INTERPRETATION BY TIME PERIOD**\n")
cat("==============================================\n\n")

# Extract coefficients
coefs <- coef(model_interaction)

# Calculate effective coefficients for each period
cat("**Effective Coefficients by Period:**\n\n")

# Pre-COVID (baseline)
cat("**Pre-COVID (2018-2019) - Baseline Coefficients:**\n")
cat(sprintf("- Price: %.4f\n", coefs["price"]))
cat(sprintf("- Delivery: %.4f\n", coefs["has_delivery"]))
cat(sprintf("- Takeout: %.4f\n", coefs["has_takeout"]))
cat(sprintf("- Log(Reviews): %.4f\n\n", coefs["log_reviews"]))

# COVID Era
cat("**COVID Era (2020-2021) - Modified Coefficients:**\n")
cat(sprintf("- Price: %.4f (baseline) + %.4f (interaction) = %.4f\n", 
            coefs["price"], coefs["price:covid_period"], coefs["price"] + coefs["price:covid_period"]))
cat(sprintf("- Delivery: %.4f (baseline) + %.4f (interaction) = %.4f\n", 
            coefs["has_delivery"], coefs["has_delivery:covid_period"], coefs["has_delivery"] + coefs["has_delivery:covid_period"]))
cat(sprintf("- Takeout: %.4f (baseline) + %.4f (interaction) = %.4f\n", 
            coefs["has_takeout"], coefs["has_takeout:covid_period"], coefs["has_takeout"] + coefs["has_takeout:covid_period"]))
cat(sprintf("- Log(Reviews): %.4f (baseline) + %.4f (interaction) = %.4f\n\n", 
            coefs["log_reviews"], coefs["log_reviews:covid_period"], coefs["log_reviews"] + coefs["log_reviews:covid_period"]))

# Post-COVID
cat("**Post-COVID (2022-2023) - Modified Coefficients:**\n")
cat(sprintf("- Price: %.4f (baseline) + %.4f (interaction) = %.4f\n", 
            coefs["price"], coefs["price:post_period"], coefs["price"] + coefs["price:post_period"]))
cat(sprintf("- Delivery: %.4f (baseline) + %.4f (interaction) = %.4f\n", 
            coefs["has_delivery"], coefs["has_delivery:post_period"], coefs["has_delivery"] + coefs["has_delivery:post_period"]))
cat(sprintf("- Takeout: %.4f (baseline) + %.4f (interaction) = %.4f\n", 
            coefs["has_takeout"], coefs["has_takeout:post_period"], coefs["has_takeout"] + coefs["has_takeout:post_period"]))
cat(sprintf("- Log(Reviews): %.4f (baseline) + %.4f (interaction) = %.4f\n\n", 
            coefs["log_reviews"], coefs["log_reviews:post_period"], coefs["log_reviews"] + coefs["log_reviews:post_period"]))

# ============================================================================
# KEY FINDINGS FROM MODEL 2
# ============================================================================

cat("**KEY FINDINGS FROM TIME-VARYING COEFFICIENTS MODEL**\n")
cat("======================================================\n\n")

# Calculate percentage changes
delivery_pre <- coefs["has_delivery"]
delivery_covid <- coefs["has_delivery"] + coefs["has_delivery:covid_period"]
delivery_post <- coefs["has_delivery"] + coefs["has_delivery:post_period"]

price_pre <- coefs["price"]
price_covid <- coefs["price"] + coefs["price:covid_period"]
price_post <- coefs["price"] + coefs["price:post_period"]

cat("**1. DELIVERY COEFFICIENT EVOLUTION:**\n")
cat(sprintf("   - Pre-COVID: %.4f\n", delivery_pre))
cat(sprintf("   - COVID Era: %.4f\n", delivery_covid))
cat(sprintf("   - Post-COVID: %.4f\n", delivery_post))
cat(sprintf("   - **Change from Pre-COVID to COVID Era: %.1f%%**\n", 
            ((delivery_covid - delivery_pre) / abs(delivery_pre)) * 100))
cat(sprintf("   - **Sustained effect in Post-COVID: %.1f%%**\n\n", 
            ((delivery_post - delivery_pre) / abs(delivery_pre)) * 100))

cat("**2. PRICE SENSITIVITY CHANGES:**\n")
cat(sprintf("   - Pre-COVID: %.4f\n", price_pre))
cat(sprintf("   - COVID Era: %.4f\n", price_covid))
cat(sprintf("   - Post-COVID: %.4f\n", price_post))
cat(sprintf("   - **Price sensitivity increased by %.1f%% during COVID**\n", 
            ((abs(price_covid) - abs(price_pre)) / abs(price_pre)) * 100))
cat(sprintf("   - **Moderated but remained elevated post-COVID**\n\n"))

cat("**3. STATISTICAL SIGNIFICANCE:**\n")
significant_interactions <- model_interaction_summary$p.value < 0.05
interaction_terms <- grepl(":", model_interaction_summary$term)
sig_interactions <- sum(significant_interactions & interaction_terms)
total_interactions <- sum(interaction_terms)

cat(sprintf("   - %d out of %d interaction terms are statistically significant (p < 0.05)\n", 
            sig_interactions, total_interactions))
cat("   - Strong evidence for structural breaks during COVID-19 period\n")
cat("   - Model explains significantly more variation than baseline model\n\n")

cat("**ECONOMIC INTERPRETATION:**\n")
cat("============================\n")
cat("The time-varying coefficients model reveals that COVID-19 created permanent\n")
cat("structural changes in restaurant consumer behavior. The large, significant\n")
cat("interaction terms demonstrate that delivery capability became dramatically more\n")
cat("important during the pandemic, while price sensitivity intensified. These effects\n")
cat("largely persisted in the post-COVID period, suggesting fundamental shifts in\n")
cat("dining preferences rather than temporary adaptations.\n")
```


